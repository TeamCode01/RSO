{% extends 'reports/base.html' %} 
{% load static %} 
{% block content %}
    {% include 'reports/header.html' %}
    <div class="container">
        <h2>Привет, {{ user.get_full_name }}!</h2>
        <h1>Доступные отчеты:</h1>
        <div class="search-container">
            <input type="text" id="reportSearch" placeholder="Поиск отчетов...">
        </div>
        <div class="grid-container" id="buttonContainer">
            <a href="{% url 'safety_test_results' %}" class="button">Результаты тестирования по безопасности</a>
            <a href="{% url 'competition_participants' %}" class="button">Общая выгрузка участников конкурса</a>
            <a href="{% url 'detachment_q_results' %}" class="button">Общая выгрузка участников конкурса по всем показателям</a>
            <a href="{% url 'detachment_q_debut_results' %}" class="button">Общая выгрузка дебют-участников конкурса по всем показателям</a>
            <a href="{% url 'detachment_q_tandem_results' %}" class="button">Общая выгрузка тандем-участников конкурса по всем показателям</a>
            <button class="button" id="downloadContactDataButton">Выгрузка контактных данных руководства отрядов, участвующих в конкурсе (файл)</button>
            <button class="button" id="downloadQ5DataButton">Процент членов студенческого отряда, прошедших профессиональное обучение (файл)</button>
            <button class="button" id="downloadQ6DataButton">Участие членов студенческого отряда в обязательных общесистемных мероприятиях на региональном уровне (файл)</button>
            <button class="button" id="downloadQ7DataButton">Участие членов студенческого отряда в окружных и межрегиональных мероприятиях (файл)</button>
            <button class="button" id="downloadQ8DataButton">Участие членов студенческого отряда во всероссийских мероприятиях (файл)</button>
            <button class="button" id="downloadQ9DataButton">Призовые места отряда в окружных и межрегиональных мероприятиях и конкурсах РСО (файл)</button>
            <button class="button" id="downloadQ10DataButton">Призовые места отряда во всероссийских мероприятиях и конкурсах РСО (файл)</button>
            <button class="button" id="downloadQ11DataButton">Призовые места отряда в окружных и межрегиональных трудовых проектах (файл)</button>
            <button class="button" id="downloadQ12DataButton">Призовые места отряда во всероссийских трудовых проектах (файл)</button>
						<button class="button" id="downloadQ13DataButton">Организация собственных мероприятий отряда (файл)</button>
						<button class="button" id="downloadQ14DataButton">Отношение количества бойцов, отработавших в летнем трудовом семестре к общему числу членов отряда (файл)</button>
						<button class="button" id="downloadQ15DataButton">Победы членов отряда в региональных, окружных и всероссийских грантовых конкурсах(файл)</button>
						<button class="button" id="downloadQ16DataButton">Активность отряда в социальных сетях (файл)</button>
						<button class="button" id="downloadQ17DataButton">Количество упоминаний в СМИ о прошедших творческих, добровольческих ипатриотических мероприятиях отряда (файл)</button>
						<button class="button" id="downloadQ18DataButton">Охват бойцов, принявших участие во Всероссийском дне ударного труда (файл)</button>
                        <button class="button" id="downloadQ19DataButton">Отсутствие нарушений техники безопасности, охраны труда и противопожарной безопасности в трудовом семестре (файл)</button>
                        <button class="button" id="downloadCentralHqButton">Реестр: ЦШ (файл)</button>
                        <button class="button" id="downloadDistrictHqButton">Реестр ОШ (файл)</button>
                        <button class="button" id="downloadRegionalHqButton">Реестр РШ (файл)</button>
                        <button class="button" id="downloadLocalHqButton">Реестр МШ (файл)</button>
                        <button class="button" id="downloadEducationalHqButton">Реестр СО ОО (файл)</button>
                        <button class="button" id="downloadDetachmentButton">Реестр ЛСО (файл)</button>
                        <button class="button" id="downloadDirectionButton">Реестр Направление (файл)</button>
                        <button class="button" id="downloadUsersButton">Реестр Участники (файл)</button>
{#            <a href="/report2" class="button">Отчет 2</a>#}
{#            <a href="/report3" class="button">Отчет 3</a>#}
{#            <a href="/report1" class="button">Отчет 1</a>#}
{#            <a href="/report2" class="button">Отчет 2</a>#}
{#            <a href="/report3" class="button">Отчет 3</a>#}
{#            <a href="/report1" class="button">Отчет 1</a>#}
{#            <a href="/report2" class="button">Отчет 2</a>#}
{#            <a href="/report3" class="button">Отчет 3</a>#}
{#            <a href="/report1" class="button">Отчет 1</a>#}
{#            <a href="/report2" class="button">Отчет 2</a>#}
{#            <a href="/report3" class="button">Отчет 3</a>#}
            <a href="{% url 'commander_school' %}" class="button">Прохождение Командиром и Комиссаром школы командирского состава</a>
            <a href="{% url 'membership_fee' %}" class="button">Численность членов отряда в соответствии с объемом уплаченных членских взносов</a>
            <a href="{% url 'attributes_of_uniform' %}" class="button">Соответствие требованиям и положению символики и атрибутике форменной одежды и символики отрядов (файл)</a>
            <!-- отчеты размещать здесь -->
        </div>
    </div>
    <script>
        function setupDownloadButton(buttonId, url, defaultText) {
            document.getElementById(buttonId).addEventListener('click', function() {
                const button = this;
                button.disabled = true;
                button.textContent = 'Подождите, файл готовится...';
    
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const taskId = data.task_id;
                        const intervalId = setInterval(() => {
                            fetch(`/reports/task-status/${taskId}/`)
                                .then(response => response.json())
                                .then(statusData => {
                                    if (statusData.status === 'SUCCESS') {
                                        clearInterval(intervalId);
                                        window.location.href = statusData.download_url;
                                        button.disabled = false;
                                        button.textContent = defaultText;
                                    } else if (statusData.status === 'FAILURE') {
                                        clearInterval(intervalId);
                                        button.disabled = false;
                                        button.textContent = 'Ошибка при подготовке файла. Попробуйте снова.';
                                    }
                                });
                        }, 2000);
                    });
            });
        }
    
        setupDownloadButton('downloadContactDataButton', '{% url "competition_participants_contact_data" %}', 'Выгрузка контактных данных руководства отрядов, участвующих в конкурсе (файл)');
        setupDownloadButton('downloadQ5DataButton', '{% url "export_q5_data" %}', 'Процент членов студенческого отряда, прошедших профессиональное обучение (файл)');
        setupDownloadButton('downloadQ6DataButton', '{% url "export_q6_data" %}', 'Участие членов студенческого отряда в обязательных общесистемных мероприятиях на региональном уровне (файл)');
        setupDownloadButton('downloadQ7DataButton', '{% url "export_q7_data" %}', 'Участие членов студенческого отряда в окружных и межрегиональных мероприятиях (файл)');
        setupDownloadButton('downloadQ8DataButton', '{% url "export_q8_data" %}', 'Участие членов студенческого отряда во всероссийских мероприятиях (файл)');
        setupDownloadButton('downloadQ9DataButton', '{% url "export_q9_data" %}', 'Призовые места отряда в окружных и межрегиональных мероприятиях и конкурсах РСО (файл)');
        setupDownloadButton('downloadQ10DataButton', '{% url "export_q10_data" %}', 'Призовые места отряда во всероссийских мероприятиях и конкурсах РСО (файл)');
        setupDownloadButton('downloadQ11DataButton', '{% url "export_q11_data" %}', 'Призовые места отряда в окружных и межрегиональных трудовых проектах (файл)');
        setupDownloadButton('downloadQ12DataButton', '{% url "export_q12_data" %}', 'Призовые места отряда во всероссийских трудовых проектах (файл)');
        setupDownloadButton('downloadQ13DataButton', '{% url "export_q13_data" %}', 'Организация собственных мероприятий отряда (файл)');
        setupDownloadButton('downloadQ14DataButton', '{% url "export_q14_data" %}', 'Отношение количества бойцов, отработавших в летнем трудовом семестре к общему числу членов отряда (файл)');
        setupDownloadButton('downloadQ15DataButton', '{% url "export_q15_data" %}','Победы членов отряда в региональных, окружных и всероссийских грантовых конкурсах (файл)');
        setupDownloadButton('downloadQ16DataButton', '{% url "export_q16_data" %}', 'Активность отряда в социальных сетях (файл)');
        setupDownloadButton('downloadQ17DataButton', '{% url "export_q17_data" %}', 'Количество упоминаний в СМИ о прошедших творческих, добровольческих и патриотических мероприятиях отряда (файл)');
        setupDownloadButton('downloadQ18DataButton', '{% url "export_q18_data" %}', 'Охват бойцов, принявших участие во Всероссийском дне ударного труда (файл)');
        setupDownloadButton('downloadQ19DataButton', '{% url "export_q19_data" %}', 'Отсутствие нарушений техники безопасности, охраны труда и противопожарной безопасности в трудовом семестре (файл)');
        setupDownloadButton('downloadCentralHqButton', '{% url "export_central_hq_data" %}', 'Реестр ЦШ (файл)');
        setupDownloadButton('downloadDistrictHqButton', '{% url "export_district_hq_data" %}', 'Реестр ОШ (файл)');
        setupDownloadButton('downloadRegionalHqButton', '{% url "export_regional_hq_data" %}', 'Реестр РШ (файл)');
        setupDownloadButton('downloadLocalHqButton', '{% url "export_local_hq_data" %}', 'Реестр МШ (файл)');
        setupDownloadButton('downloadEducationalHqButton', '{% url "export_education_hq_data" %}', 'Реестр СО ОО (файл)');
        setupDownloadButton('downloadDetachmentButton', '{% url "export_detachment_data" %}', 'Реестр ЛСО (файл)');
        setupDownloadButton('downloadDirectionButton', '{% url "export_direction_data" %}', 'Реестр Направление (файл)')
        setupDownloadButton('downloadUsersButton', '{% url "export_users_data" %}', 'Реестр Участники (файл)')

        const searchInput = document.getElementById('reportSearch');
        const buttonContainer = document.getElementById('buttonContainer');
        const buttons = buttonContainer.getElementsByTagName('button');
    
        searchInput.addEventListener('input', function() {
            const filter = searchInput.value.toLowerCase();
            for (const button of buttons) {
                const text = button.textContent || button.innerText;
                button.style.display = text.toLowerCase().indexOf(filter) > -1 ? '' : 'none';
            }
        });
    </script>
{% endblock %}
